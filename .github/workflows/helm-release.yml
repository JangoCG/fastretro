name: Release Helm Chart

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_APP_NAME=FastRetro
            VITE_REVERB_APP_KEY=${{ secrets.REVERB_APP_KEY }}

  package-and-release-chart:
    runs-on: ubuntu-latest
    needs: build-and-push-image
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Update Chart version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          sed -i "s/^version:.*/version: $VERSION/" helm/fastretro/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"$VERSION\"/" helm/fastretro/Chart.yaml

      - name: Update image tag in values.yaml
        run: |
          IMAGE_TAG="${{ needs.build-and-push-image.outputs.image-tag }}"
          sed -i "s/tag: \"\"/tag: \"$IMAGE_TAG\"/" helm/fastretro/values.yaml

      - name: Lint Helm chart
        run: |
          helm lint helm/fastretro

      - name: Package Helm chart
        run: |
          mkdir -p .helm-repo
          helm package helm/fastretro -d .helm-repo

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0
        continue-on-error: true

      - name: Create gh-pages branch if it doesn't exist
        if: failure()
        run: |
          mkdir -p gh-pages
          cd gh-pages
          git init
          git checkout -b gh-pages
          git remote add origin https://github.com/${{ github.repository }}.git

      - name: Update Helm repository index
        run: |
          # Copy new package to gh-pages
          cp .helm-repo/*.tgz gh-pages/

          # Generate/update index
          cd gh-pages
          helm repo index . --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

          # Create index.html if it doesn't exist
          if [ ! -f index.html ]; then
            cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>FastRetro Helm Chart Repository</title>
              <style>
                  body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
                  h1 { color: #333; }
                  code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
                  pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
              </style>
          </head>
          <body>
              <h1>FastRetro Helm Chart Repository</h1>
              <p>This is the Helm chart repository for FastRetro - a real-time collaborative retrospective and task management application.</p>

              <h2>Usage</h2>
              <p>Add this Helm repository:</p>
              <pre>helm repo add fastretro https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          helm repo update</pre>

              <h2>Installation</h2>
              <p>Install FastRetro:</p>
              <pre>helm install my-fastretro fastretro/fastretro --version [VERSION]</pre>

              <p>Or with custom values:</p>
              <pre>helm install my-fastretro fastretro/fastretro \
            --set app.url=https://fastretro.example.com \
            --set app.key=base64:your-app-key \
            --set reverb.appId=your-app-id \
            --set reverb.appKey=your-app-key \
            --set reverb.appSecret=your-app-secret \
            --set ingress.enabled=true \
            --set ingress.hosts[0].host=fastretro.example.com</pre>

              <h2>Available Charts</h2>
              <p>View available charts and versions in <a href="index.yaml">index.yaml</a></p>

              <h2>Source Code</h2>
              <p>Source code: <a href="https://github.com/${{ github.repository }}">github.com/${{ github.repository }}</a></p>
          </body>
          </html>
          EOF
          fi

      - name: Commit and push changes
        working-directory: gh-pages
        run: |
          git add .
          git commit -m "Release Helm chart from ${{ github.ref_name }}" || echo "No changes to commit"
          git push origin gh-pages --force

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: .helm-repo/*.tgz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-pages:
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    needs: package-and-release-chart
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
