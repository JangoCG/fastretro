<% @page_title = "#{@retro.name} - #{@retro.phase.titleize}" %>

<!DOCTYPE html>
<html class="h-full">
<head>
  <%= page_title_tag %>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Fast Retro">
  <meta name="mobile-web-app-capable" content="yes">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%= yield :head %>

  <%# Turbo 8: Enable morph refreshes with scroll preservation %>
  <%= turbo_refreshes_with method: :morph, scroll: :preserve %>

  <link rel="icon" href="/icon.png" type="image/png">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/icon.png">

  <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
  <%= javascript_importmap_tags %>
</head>

<%#
    BODY STYLING:
    - bg-zinc-100: A cool grey base that contrasts with the warm #F8F5EC cards.
    - selection:bg-[#ffe600]: Highlights text in "Highlighter Yellow".
    - overflow-x-hidden: Prevents horizontal scroll from the hanging tag animations.
  %>
<body class="bg-zinc-100 text-zinc-900 transition-colors min-h-screen flex flex-col font-sans antialiased overflow-x-hidden selection:bg-[#ffe600] selection:text-black"
      data-controller="elevator-music"
      data-elevator-music-url-value="<%= retro_music_path(@retro) %>"
      data-elevator-music-playing-value="<%= @retro.music_playing? %>">

<%# Turbo 8: Subscribe to retro stream for real-time updates %>
<%= turbo_stream_from @retro %>
<%= turbo_stream_from [@retro, Current.user] if Current.user.present? %>

<%# === BACKGROUND TEXTURE (The Dot Grid) === %>
<%# This creates a technical 'cutting mat' feel behind your content %>
<div class="fixed inset-0 z-[-1] pointer-events-none opacity-[0.4]"
     style="background-image: radial-gradient(#a1a1aa 1px, transparent 1px); background-size: 24px 24px;">
</div>

<%# === HEADER === %>
<%# Kept transparent so your new "Floating System Menu" sits on top of the grid %>
<% if authenticated? %>
  <header class="z-40 relative flex justify-start sm:justify-center px-4 sm:px-6 md:px-8 xl:px-16">
    <%= render "my/menu" %>
    <div class="absolute right-4 sm:right-6 md:right-8 xl:right-16 top-4 flex items-center gap-2">
      <% if @retro.admin?(Current.user) %>
        <%= render MusicToggleComponent.new(retro: @retro, style: :topbar) %>
      <% end %>

      <%= link_to new_site_feedback_path(script_name: nil), class: "hidden sm:inline-flex w-10 h-10 xl:w-[15rem] xl:h-11 justify-center items-center gap-2 px-0 xl:px-4 bg-slate-600 text-white border-[2px] border-zinc-900 font-bold uppercase tracking-widest text-[10px] sm:text-xs hover:bg-slate-700 transition-colors shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] hover:shadow-none" do %>
        <%= icon_tag "chat", class: "w-3.5 h-3.5 sm:w-4 sm:h-4" %>
        <span class="hidden xl:inline">Give us feedback</span>
      <% end %>
    </div>
  </header>
<% end %>

<%# === MAIN CONTENT === %>
<main id="main">
  <div class="px-4 sm:px-6 md:px-8 xl:px-16 pt-2 sm:pt-0 pb-8 sm:pb-16">
    <div class="pt-3 sm:pt-0 pb-4 sm:pb-4">
      <%= render BackButtonComponent.new(label: "Retros", href: retros_path, variant: :fizzy) %>
    </div>

    <%= render "feedbacks/near_limit_notice" %>

    <% if notice.present? %>
      <p class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-md inline-block" id="notice"><%= notice %></p>
    <% end %>

    <%# Header - all screen sizes %>
    <div id="header-container" class="mt-0 sm:mt-4 md:mt-0 mb-6 sm:mb-8 font-sans">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4 md:gap-6 md:items-start">
        <div class="text-center sm:text-left">
          <% retro_display_name = @retro.name.presence || "Retro" %>
          <h1 class="font-black text-xl sm:text-2xl md:text-3xl lg:text-4xl text-zinc-900 uppercase tracking-tighter leading-none">
            "<%= retro_display_name %>"
          </h1>
          <%
            phase_colors = {
              "action_review" => "bg-violet-200 text-violet-900",
              "brainstorming" => "bg-amber-200 text-amber-900",
              "grouping" => "bg-sky-200 text-sky-900",
              "voting" => "bg-violet-200 text-violet-900",
              "discussion" => "bg-emerald-200 text-emerald-900",
              "complete" => "bg-zinc-300 text-zinc-900",
              "waiting_room" => "bg-zinc-200 text-zinc-700"
            }
            color_classes = phase_colors[@retro.phase] || "bg-zinc-200 text-zinc-700"
          %>
          <p class="hidden sm:inline-block font-bold text-xs sm:text-sm md:text-base uppercase tracking-widest mt-1.5 sm:mt-2 px-1.5 sm:px-2 py-0.5 -rotate-1 <%= color_classes %>">
            "<%= @retro.phase.tr('_', ' ') %>"
          </p>
          <p class="mt-2 text-xs sm:text-sm text-zinc-700 font-medium leading-relaxed max-w-xl">
            <span class="font-black uppercase tracking-wide text-zinc-900">What to do:</span>
            <%= retro_phase_instruction(@retro.phase) %>
          </p>
        </div>

        <% if content_for?(:header_actions) %>
          <div class="flex justify-center md:justify-center md:pt-1">
            <%= yield :header_actions %>
          </div>
        <% else %>
          <div class="hidden md:block"></div>
        <% end %>

        <div class="w-full md:w-auto flex flex-col items-stretch gap-2 md:items-end md:justify-self-end">

          <%# Hidden audio element for elevator music %>
          <audio id="elevator-music-audio"
                 data-elevator-music-target="audio"
                 src="<%= asset_path('elevator-music-bossa-nova-background-music-version-60s-10900.mp3') %>"
                 loop
                 preload="auto"
                 style="display: none;">
          </audio>

          <%# Enable audio prompt for participants (shown when browser blocks autoplay) %>
          <button type="button"
                  id="music-enable-prompt"
                  data-elevator-music-target="prompt"
                  data-action="click->elevator-music#enableAudio"
                  class="hidden w-full md:w-auto h-10 sm:h-12 px-4 sm:px-6 font-bold uppercase tracking-widest text-xs sm:text-sm bg-amber-400 text-zinc-900 border-[2px] border-zinc-900 rounded-[1px] transition-all duration-200 shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] hover:shadow-none hover:-translate-y-0.5 active:translate-y-0 animate-pulse">
            <span class="flex items-center gap-2">
              <span>ðŸŽµ</span>
              <span>Click to enable music</span>
            </span>
          </button>

          <%# Primary controls stack: full-width mobile actions in meaningful order %>
          <div class="w-full flex flex-col items-stretch gap-2 md:flex-row md:flex-nowrap md:justify-end">
            <%# 1) Participant finishes own work %>
            <% if @current_participant.present? && !@retro.complete? %>
              <%= button_to retro_finished_path(@retro),
                      method: :patch,
                      id: "participant-finished-button",
                      class: class_names(
                      "w-full md:w-auto h-10 sm:h-12 px-3 sm:px-8 min-w-0 justify-center whitespace-nowrap font-bold uppercase tracking-[0.12em] md:tracking-widest text-xs sm:text-sm border-[2px] rounded-[1px] transition-all duration-200 shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] sm:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-none hover:-translate-y-0.5 active:translate-y-0",
                      @current_participant.finished? ? "bg-emerald-100 border-emerald-700 text-emerald-900 hover:bg-emerald-200" : "bg-emerald-500 border-emerald-700 text-white hover:bg-emerald-600"
                    ) do %>
                <%= @current_participant.finished? ? "Finished" : "I am finished" %>
              <% end %>
            <% end %>

            <%# 2) Admin advances phase %>
            <% if @retro.admin?(Current.user) && !@retro.last_phase? %>
              <%= render ConfirmPhaseModalComponent.new(retro: @retro) %>
            <% end %>

            <%# 3) Admin goes back phase %>
            <% if @retro.admin?(Current.user) && @retro.can_go_back? %>
              <%= render ConfirmBackPhaseModalComponent.new(retro: @retro) %>
            <% end %>
          </div>
        </div>
      </div>

      <div class="h-[2px] sm:h-[3px] bg-zinc-900 mt-3 sm:mt-4"></div>
    </div>

    <%# CONTENT GRID %>
    <div id="retro-content-grid"
         class="grid grid-cols-12 gap-4 sm:gap-6 lg:gap-8 relative z-10"
         <% if @retro.highlighted_user_id.present? %>data-highlighted-user-id="<%= @retro.highlighted_user_id %>"<% end %>
         <% if @retro.grouping? && @retro.admin?(Current.user) %>
           data-controller="participant-highlight"
           data-participant-highlight-url-value="<%= retro_highlight_path(@retro) %>"
         <% end %>
    >

      <%# The Board %>
      <div class="col-span-12 lg:col-span-9 order-2 lg:order-1">
        <% if content_for?(:board_columns) %>
          <%= yield :board_columns %>
        <% else %>
          <div class="grid gap-6 sm:gap-8" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
            <% feedbacks_by_category = @feedbacks_by_category %>
            <% @retro.column_definitions.each_with_index do |column, index| %>
              <% column_feedbacks = feedbacks_by_category&.[](column["id"]) %>
              <%= render Retros::ColumnComponent.new(
                retro: @retro,
                category: column["id"],
                title: column["name"],
                position: index,
                participant: @current_participant,
                feedbacks: feedbacks_by_category.nil? ? nil : (column_feedbacks || []),
                has_feedbacks: feedbacks_by_category.nil? ? nil : column_feedbacks.present?
              ) %>
            <% end %>
          </div>
        <% end %>
      </div>

      <%# Participants - on mobile, show compact version at top %>
      <div class="col-span-12 lg:col-span-3 order-1 lg:order-2">
        <div class="lg:sticky lg:top-8 flex flex-col gap-4 sm:gap-6">
          <%# On mobile/tablet, show invite and participants side by side %>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 items-start gap-4 sm:gap-6">
            <%= render RetroInviteCardComponent.new(retro: @retro) %>
            <% if content_for?(:sidebar_tip) %>
              <div class="desktop-only-block">
                <%= yield :sidebar_tip %>
              </div>
            <% end %>
            <div id="participant-list">
              <%= render ParticipantListComponent.new(retro: @retro, highlight_enabled: @retro.grouping? && @retro.admin?(Current.user)) %>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<%# === FOOTER === %>
<%= render RetroFooterComponent.new %>
</body>
</html>
