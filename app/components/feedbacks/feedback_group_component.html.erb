<div
  id="<%= dom_id(@group) %>"
  class="relative mt-3 p-2 border-2 border-dashed rounded-lg transition-all duration-200 <%= discussed? ? 'border-emerald-600 bg-emerald-50/50' : 'border-yellow-500 bg-yellow-50/30' %>"
  data-user-ids="<%= author_user_ids %>"
  <% if @grouping_enabled %>
    data-feedback-id="group-<%= @group.id %>"
    data-feedback-grouping-target="feedback"
  <% end %>
  <% if @voting_enabled %>
    data-vote-sorting-target="item"
  <% end %>
>
  <%# Grouped feedbacks container with dashed border %>
  <div class="relative">
    <%# Background stacked cards effect %>
    <% if other_feedbacks.any? %>
      <div class="absolute -bottom-1 left-1 right-1 h-full bg-zinc-200 border-[2px] border-zinc-900 rounded-sm"></div>
      <% if other_feedbacks.size > 1 %>
        <div class="absolute -bottom-2 left-2 right-2 h-full bg-zinc-300 border-[2px] border-zinc-900 rounded-sm"></div>
      <% end %>
    <% end %>

    <%# Primary card %>
    <div class="relative bg-white border-[2px] border-zinc-900 shadow-[4px_4px_0px_0px_rgba(24,24,27,1)] overflow-hidden">
      <%# Group badge %>
      <div class="absolute top-2 right-2 z-10 flex items-center gap-1 <%= discussed? ? 'bg-emerald-300' : 'bg-yellow-400' %> px-2 py-0.5 border border-zinc-900">
        <span class="text-[0.6rem] font-black text-zinc-900 uppercase tracking-wider">
          <%= @feedbacks.size %> grouped
        </span>
      </div>

      <%# Content area %>
      <div class="p-4">
        <%# Technical Header %>
        <div class="flex justify-between items-center border-b-[2px] border-zinc-100 pb-2 mb-3">
          <span class="text-[0.6rem] font-bold text-zinc-400 uppercase tracking-widest font-mono">
            GROUP_<%= @group.id %>
          </span>
          <% if discussion_enabled? && discussed? %>
            <span class="text-[0.55rem] font-bold text-emerald-700 uppercase tracking-wider px-1.5 py-0.5 border border-emerald-600 rounded bg-emerald-100">
              Discussed
            </span>
          <% end %>
        </div>

        <%# Show preview of all feedbacks in group %>
        <div class="space-y-3">
          <% @feedbacks.each_with_index do |feedback, index| %>
            <div class="<%= index > 0 ? 'border-t border-zinc-200 pt-3' : '' %>"
                 data-user-id="<%= feedback.user_id %>"
                 <% if feedback_highlighted?(feedback) %>data-highlighted="true"<% end %>>
              <div class="flex justify-between items-start gap-2">
                <div class="flex-1 min-w-0 text-zinc-900 font-bold text-sm leading-snug break-words">
                  <div class="rich-text-content">
                    <%= feedback.content %>
                  </div>
                </div>
                <% if @grouping_enabled %>
                  <%= button_to remove_feedback_retro_feedback_groups_path(feedback.retro, feedback_id: feedback.id, script_name: feedback.retro.account.slug),
                      method: :delete,
                      class: "shrink-0 text-[0.5rem] font-bold text-zinc-500 hover:text-zinc-900 uppercase tracking-wider transition-colors px-1.5 py-0.5 border border-zinc-300 hover:border-zinc-500 rounded bg-zinc-50 hover:bg-zinc-100",
                      title: "Remove from group" do %>
                    Ungroup
                  <% end %>
                <% end %>
              </div>
              <div class="flex items-center gap-2 mt-2">
                <div class="w-4 h-4 bg-zinc-900 text-white flex items-center justify-center text-[0.5rem] font-black uppercase">
                  <%= feedback.user.initials %>
                </div>
                <span class="text-[0.55rem] font-bold text-zinc-400 uppercase tracking-wider">
                  <%= feedback.user.name %>
                </span>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <%# Ungroup button for admins %>
      <% if @grouping_enabled %>
        <div class="px-4 py-2 border-t border-zinc-200 bg-zinc-50">
          <%= button_to retro_feedback_group_path(primary_feedback.retro, @group, script_name: primary_feedback.retro.account.slug),
              method: :delete,
              id: "ungroup-all-feedback-group-#{@group.id}",
              class: "text-[0.6rem] font-bold text-zinc-500 hover:text-zinc-900 uppercase tracking-wider transition-colors" do %>
            Ungroup all
          <% end %>
        </div>
      <% end %>

      <%# Voting controls %>
      <% if show_voting? %>
        <div class="px-4 py-3 border-t border-zinc-200 bg-zinc-50 flex justify-end">
          <%= render VoteButtonComponent.new(voteable: @group, participant: @participant, retro: @retro) %>
        </div>
      <% elsif show_vote_count? || can_mark_discussed? %>
        <div class="px-4 py-3 border-t border-zinc-200 bg-zinc-50 flex justify-end gap-2">
          <% if show_vote_count? %>
            <div class="flex items-center justify-center min-w-[2.5rem] h-8 px-2 bg-violet-100 border-2 border-violet-600 text-violet-700 font-black text-sm">
              <%= @group.votes.size %>
            </div>
          <% end %>
          <% if can_mark_discussed? %>
            <%= button_to retro_discussion_item_path(@retro, script_name: @retro.account.slug),
                method: :patch,
                params: {
                  item_type: "FeedbackGroup",
                  item_id: @group.id,
                  discussed: !discussed?
                },
                class: "text-[0.55rem] font-bold uppercase tracking-wider transition-colors px-2 py-1 border rounded #{discussed? ? 'text-emerald-700 border-emerald-600 bg-emerald-100 hover:bg-emerald-200' : 'text-zinc-600 border-zinc-300 bg-zinc-100 hover:bg-zinc-200'}" do %>
              <%= discussed? ? "Undo" : "Mark discussed" %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
